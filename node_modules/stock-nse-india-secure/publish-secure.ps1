# PowerShell script to publish the secure stock-nse-india fork
$ErrorActionPreference = "Stop"

Write-Host "üîí Publishing secure stock-nse-india fork..." -ForegroundColor Green

# Check if logged into npm
Write-Host "üìã Checking npm authentication..." -ForegroundColor Yellow
try {
    $npmUser = npm whoami 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Logged in as: $npmUser" -ForegroundColor Green
    } else {
        throw "Not logged in"
    }
} catch {
    Write-Host "‚ùå Not logged into npm. Please run:" -ForegroundColor Red
    Write-Host "   npm login" -ForegroundColor White
    Write-Host "   or" -ForegroundColor White
    Write-Host "   npm adduser" -ForegroundColor White
    exit 1
}

# Verify package.json
Write-Host "üì¶ Verifying package configuration..." -ForegroundColor Yellow
if (!(Test-Path "package.json")) {
    Write-Host "‚ùå package.json not found!" -ForegroundColor Red
    exit 1
}

$packageJson = Get-Content "package.json" | ConvertFrom-Json
Write-Host "   Package: $($packageJson.name)" -ForegroundColor White
Write-Host "   Version: $($packageJson.version)" -ForegroundColor White

# Check if package already exists
Write-Host "üîç Checking if package version already exists..." -ForegroundColor Yellow
try {
    $existingPackage = npm view $packageJson.name version 2>$null
    if ($LASTEXITCODE -eq 0 -and $existingPackage -eq $packageJson.version) {
        Write-Host "‚ö†Ô∏è  Version $($packageJson.version) already exists!" -ForegroundColor Yellow
        Write-Host "   Consider bumping the version number." -ForegroundColor White
        $continue = Read-Host "Continue anyway? (y/N)"
        if ($continue -ne "y" -and $continue -ne "Y") {
            Write-Host "‚ùå Publish cancelled." -ForegroundColor Red
            exit 1
        }
    }
} catch {
    Write-Host "‚úÖ Package version is new." -ForegroundColor Green
}

# Build the package
Write-Host "üî® Building package..." -ForegroundColor Yellow
npm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Build failed!" -ForegroundColor Red
    exit 1
}

# Publish the package
Write-Host "üöÄ Publishing to npm..." -ForegroundColor Yellow
npm publish --access public
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Publish failed!" -ForegroundColor Red
    exit 1
}

Write-Host "üéâ Successfully published!" -ForegroundColor Green
Write-Host "üìã Next steps:" -ForegroundColor Cyan
Write-Host "   1. Update your project's package.json:" -ForegroundColor White
Write-Host "      npm uninstall stock-nse-india" -ForegroundColor Gray
Write-Host "      npm install @vercelink/stock-nse-india-secure" -ForegroundColor Gray
Write-Host "   2. Update import statements in your code" -ForegroundColor White
Write-Host "   3. Test your application" -ForegroundColor White
Write-Host "   4. Deploy to Vercel" -ForegroundColor White
